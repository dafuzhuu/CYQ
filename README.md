**筹码策略**

```
CYQ
├── __pycache__
├── README.md
├── data
		├── daily_chips   // 日频筹码分布csv文件
		├── weekly_chips  // 周频筹码分布csv文件
		├── factors       // 因子值
		├── return        // 每周收盘价、涨跌幅
		└── raw_data      // 股票周频基本信息
├── main
		├── main.py       // 计算并输出筹码时序数据（日频、周频）
		├── main2.py      // 计算筹码分布衍生指标
		├── main3.py      // 获取股票每周涨跌幅
		├── main4.py			// 因子有效性测试
		└── main5.py			// 构建投资组合
├── util
		├── FactorAPI.py
		└── tools.py
├── result
		├── ic.csv
		└── ic_measures.csv
└── doc
```

## 筹码分布计算原理

首先需要估算每只股票每天的筹码分布情况。筹码分布又称“流通股票持仓成本分布”，设计算法如下：

换手率公式为

$$
\text{turnover}=\frac{成交量(vol)}{自由流通股数(C)}
$$

记 $C_0$为昨日总自由流通股数， $C_1$为今日总自由流通股数，今日成交量为 $vol$。今日最高价为 $P_{max}$，最低价为 $P_{min}$，历史最高价为 $p_{max}$，最低价为 $p_{min}$。

当$p_{max}-p_{min}>5$时以$0.1$为最小价格变化量，否则以$0.01$​为最小价格变化量，即
$$
\Delta =\begin{cases}
0.1 & p_{max}-p_{min}>5\\
0.01 & \text{otherwise}
\end{cases}
$$
假设一：每日新增筹码沿$[P_{min},P_{max}]$均匀分布

假设二：每日移出筹码沿$[p_{min},p_{max}]$均匀分布

分两步计算，即移入和移出。首先移入筹码，新增筹码价格为
$$
P_{min}, (P_{min}+\Delta), (P_{min}+2\Delta),\cdots,(P_{max}-\Delta), P_{max}
$$
根据假设一，每个价位上的筹码数量为
$$
\Delta Q=\frac{vol\times \Delta}{\tilde{p}_{max}-\tilde{p}_{min}}
$$
原本的筹码价格为
$$
p_{min},(p_{min}+\Delta),\cdots,P_{min}, \cdots,P_{max},\cdots,(p_{max}-\Delta),p_{max}
$$
简化为
$$
p_1,p_2,\cdots,p_a,\cdots,p_b,\cdots,p_n
$$
其中$p_1=p_{min},p_n=p_{max},p_a=P_{min},p_b=P_{max}$。我们将其称为价格序列。

对每个筹码价格上的筹码量用$Q_{\{\cdot\}}$表示，则截止昨日的筹码分布序列为
$$
Q_{p_1},Q_{p_2},\cdots,Q_{p_a},Q_{p_{a+1}},\cdots,Q_{p_{b-1}},Q_{p_b},\cdots,Q_{p_n}
$$
我们称之为价格序列。由假设一，今日新增筹码的分布序列为
$$
\Delta Q,\Delta Q,\cdots,\Delta Q
$$
对应价格$[p_a,\cdots,p_b]$​。则移入新增筹码后的分布序列变为
$$
\{Q_{p_k}\}_{k=1}^n=Q_{p_1},Q_{p_2},\cdots,Q_{p_{a-1}},(Q_{p_a}+\Delta Q),(Q_{p_{a+1}}+\Delta Q),\cdots,(Q_{p_{b-1}}+\Delta Q),(Q_{p_b}+\Delta Q),Q_{p_{b+1}},\cdots,Q_{p_n}
$$
现在考虑筹码移出。根据假设二和下面等式
$$
C_0=\sum_{i=1}^n p_i
$$
我们等比例地移出各个价位上的筹码，使得剩余的筹码数量等于$C_1$。$(9)$式的序列之和等于$C_0+vol$，需添加一个乘数$\alpha$使其等于$C_1$
$$
(C_0+vol)\times \frac{C_1}{C_0+vol}=C_1
$$
根据换手率公式
$$
\text{turnover}=\frac{vol}{C_1}
$$
得到
$$
\alpha=\frac{C_1}{C_0+vol}=\frac{1}{\frac{C_0}{C_1}+\frac{vol}{C_1}}=\frac{1}{C_0/C_1+\text{turnover}}
$$
通常$C_1<C_0+vol$，因此$0<\alpha<1$

移出筹码后，分布序列变为
$$
\{\alpha_k \times Q_{p_k}\}_{k=1}^n
$$

## 四个基础衍生指标

陈浩《筹码分布》第三章 “筹码分布的衍生指标”

1. 活动筹码（ASR）

   以当日收盘价为基准，统计在该价位上下 10%的区间内的筹码总量， 这个筹码量就是活动筹码，代号 ASR

2. 相对价位（CKDP）
   $$
   CKDP = (当前价-最低成本价)/(最高成本价-最低成本价)\times 100\%
   $$

3. 成本重心（CKDW）
   $$
   CKDW=(平均成本价-最低成本价)/(最高成本价-最低成本价)\times 100\%
   $$

4. 成本带宽（CBW）
   $$
   CBW=(最高成本价-最低成本价)/最低成本价 \times 100\%
   $$

## IC测试

$X$为每期因子值，$Y$为下期股票涨跌幅，计算$X$和$Y$的秩相关系数即为RankIC
$$
d_i=R(X_i)-R(Y_i)
$$

$$
\rho=1-\frac{6\sum_id_i^2}{n(n^2-1)}
$$

处理表格数据时，行为时间，列为股票代码，对每行（每期）计算所有股票IC值的平均值，得到IC时间序列。再根据该时序数据计算IC均值、IC标准差等。

## 基础因子回测

### 上证中盘（000044.SH）

$n=89$

|      | mean       | max        | min        | std        | ir         |
| ---- | ---------- | ---------- | ---------- | ---------- | ---------- |
| asr  | -0.0154847 | 0.40358538 | -0.5057777 | 0.15629394 | -0.099074  |
| cbw  | 0.01930064 | 0.56979545 | -0.4941074 | 0.16956393 | 0.11382514 |
| ckdw | -0.0008332 | 0.44721565 | -0.5640011 | 0.17024188 | -0.0048941 |
| ckdp | -0.0015315 | 0.57394213 | -0.6551384 | 0.21865126 | -0.0070042 |
| comb | 0.01760196 | 0.43854448 | -0.4175883 | 0.14231837 | 0.12368014 |

![image-20240622132335295](/Users/zdf/Library/Application Support/typora-user-images/image-20240622132335295.png)

### 上证小盘（000045.SH）

$n=222$

|      | mean       | max        | min        | std        | ir         |
| ---- | ---------- | ---------- | ---------- | ---------- | ---------- |
| asr  | -0.0070845 | 0.48746643 | -0.4771542 | 0.12857973 | -0.0550981 |
| cbw  | 0.00490885 | 0.49393338 | -0.3498607 | 0.13426535 | 0.0365608  |
| ckdw | 0.00183339 | 0.35035838 | -0.4395489 | 0.14196569 | 0.01291435 |
| ckdp | -0.0181433 | 0.54673552 | -0.5743359 | 0.18585833 | -0.0976191 |
| comb | 0.01814332 | 0.57433594 | -0.5467355 | 0.18585833 | 0.09761906 |

![image-20240622140300443](/Users/zdf/Library/Application Support/typora-user-images/image-20240622140300443.png)

### 上证中小盘（000046.SH）

IC测试结果（样本量$n=331$）

|      | mean       | max        | min        | std        | ir         |
| ---- | ---------- | ---------- | ---------- | ---------- | ---------- |
| asr  | -0.0097464 | 0.39347034 | -0.4806915 | 0.1229122  | -0.079296  |
| cbw  | 0.00994224 | 0.4930616  | -0.355217  | 0.13188779 | 0.07538405 |
| ckdw | 0.00181794 | 0.35023145 | -0.4732063 | 0.13966887 | 0.01301605 |
| ckdp | -0.0128223 | 0.51043588 | -0.5741126 | 0.18750963 | -0.0683822 |
| comb | 0.01282231 | 0.57411265 | -0.5104359 | 0.18750963 | 0.06838216 |

![image-20240622134250745](/Users/zdf/Library/Application Support/typora-user-images/image-20240622134250745.png)

### 中证500（000905.SH）

样本量$n=372$

|      | mean       | max        | min        | std        | ir         |
| ---- | ---------- | ---------- | ---------- | ---------- | ---------- |
| asr  | -0.0077853 | 0.44907605 | -0.6123127 | 0.12350857 | -0.0630341 |
| cbw  | 0.00924461 | 0.39457424 | -0.3638177 | 0.11485939 | 0.08048633 |
| ckdw | 0.00029961 | 0.318863   | -0.4133553 | 0.1321533  | 0.00226715 |
| ckdp | -0.0147411 | 0.46812548 | -0.5592758 | 0.17249826 | -0.0854565 |
| comb | 0.0147411  | 0.55927578 | -0.4681255 | 0.17249826 | 0.08545653 |

![image-20240622141718246](/Users/zdf/Library/Application Support/typora-user-images/image-20240622141718246.png)

### 沪深300

$n=230$

|      | mean       | max        | min        | std        | ir         |
| ---- | ---------- | ---------- | ---------- | ---------- | ---------- |
| asr  | -0.012272  | 0.42584425 | -0.5535409 | 0.13431863 | -0.091365  |
| cbw  | 0.0155968  | 0.47182824 | -0.3106734 | 0.13330642 | 0.11699961 |
| ckdw | 0.01053854 | 0.36872082 | -0.4604511 | 0.14559985 | 0.07238019 |
| ckdp | 0.00824269 | 0.54567956 | -0.665214  | 0.20471202 | 0.04026482 |
| comb | 0.01314653 | 0.32283311 | -0.3434028 | 0.09879761 | 0.13306527 |

![image-20240622191400577](/Users/zdf/Library/Application Support/typora-user-images/image-20240622191400577.png)

经过对不同的股票池进行测试，我们发现上述指标对大市值股票相对友好，而在小盘股中的有效性很低。考虑到IC值均比较低，上述因子可能已经失效。

## 进阶指标

1. 90比3

   90 比 3 是另一种判断主力高度控盘的方法。意思是说如果一只股票在筹码分布上获利盘大于 90%，同时换手率低于 3%，则可以认定主力高度控盘。

   因子：
   $$
   \text{profit-turnover ratio} = \frac{获利盘}{换手率}
   $$


   ratio $\uparrow$, 主力控盘$\uparrow$

2. 成本均线差值

   成本均线发散的市场含义是：投资者持仓成本差异巨大，而成本均线密集则反映市场各个不同时期的平均成本相差不多。如果主力持仓量巨大，当个股巨幅上涨之后，由于大部分筹码依 然是低位区的主力持仓，因而近期短线追涨盘的成本就和主力底仓形成巨大差距；但如果主力在低位区没有巨 量持仓，那么随着股价上扬中的中小投资者获利了结，及新的追涨盘的继续接棒，其建仓位置很难高于早期获 利盘 20%，于是造成了成本均线的相对密集。

   结论：股价上升过程中成本均线呈现发散状态，这只股票是主力 高度控盘；如果股价上升过程中成本均线密集，则该股为主力的中度控盘。

   技术标准：五日成本均线高于无穷成本均线四个涨停板以上，则该股为主力的高度持仓，主力持仓量为 70%左右甚至更高一些。

   因子：
   $$
   d=MA_5-MA_{\infty}
   $$

3. Winner指标

   每天每只股票盈利部分的筹码量占比

























